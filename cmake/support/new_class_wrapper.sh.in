#!/bin/bash
# Copyright 2011-2013 by Alex Turbov <i.zaufi@gmail.com>
#
# Helper to generate class skeletons
#
# TODO Add parameters to control what to generate: header only and/or implementation
#
# TODO Guess `subdir' from `ns' and vise versa if smth absent
#
# TODO Add parameter to control filename if latter isn't same as a class name... or maybe
#      better to generate a file w/o predefined class if `fn' specified instead of `class'
#

. ${CMAKE_SOURCE_DIR}/cmake/support/output-helpers.sh

show_help()
{
    einfo "Use 'make new-class class=ClassName subdir=path/from/src/root [ns=namespaces::list]'"
    einfo "Example: make new-class class=some_class subdir=zencxx/debug ns=zencxx::debug"
}

if [ -z "$class" ]; then
    eerror "No class name provided"
    show_help
    exit 1
fi
if [ -z "$subdir" ]; then
    eerror "No subdir argument provided"
    show_help
    exit 1
fi

# Ok. Lets work!
ebegin "Generate class skeleton files for $class: $class.cc and $class.hh"
rf=${CMAKE_BINARY_DIR}/$class.def
# Generate response file for autogen
echo "autogen definitions ${CMAKE_SOURCE_DIR}/cmake/support/class.tpl;" > $rf \
  && echo "subdir=$subdir;" >> $rf \
  && echo "guard_base=`echo "$subdir" | sed -e 's,/,__,g' -e 's,[^0-9A-Za-z],_,g'`;" >> $rf \
  && echo "classname=$class;" >> $rf \
  && echo "filename=$class;" >> $rf \
  && ( test -n "$ns" && echo "$ns" | awk -F '::' -f ${CMAKE_SOURCE_DIR}/cmake/support/mknslist.awk >> $rf \
      || ( test -f ${CMAKE_SOURCE_DIR}/cmake/support/tpl-defaults.def && cat ${CMAKE_SOURCE_DIR}/cmake/support/tpl-defaults.def >> $rf ) \
      ) \
  && ${AUTOGEN_EXECUTABLE} -L ${CMAKE_SOURCE_DIR}/cmake/support $rf
result=$?
eend $result
test "$result" = "0" || exit 1


if [ "${CMAKE_BINARY_DIR}" != "${CMAKE_SOURCE_DIR}" ]; then
    # Move generated files from CMAKE_BINARY_DIR to desired subdir (if exists)
    dst=`test -d "${CMAKE_SOURCE_DIR}/$subdir" && echo "${CMAKE_SOURCE_DIR}/$subdir" || echo "${CMAKE_SOURCE_DIR}"`
    ebegin "Move generated files to $dst"
    mv -i ${CMAKE_BINARY_DIR}/$class.hh ${CMAKE_BINARY_DIR}/$class.cc $dst
    eend $?
fi

# Cleanup
ebegin "Cleanup"
rm -f $rf
eend $?
